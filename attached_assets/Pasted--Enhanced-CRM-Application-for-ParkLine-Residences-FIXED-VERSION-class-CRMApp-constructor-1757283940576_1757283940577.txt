// Enhanced CRM Application for ParkLine Residences - FIXED VERSION
class CRMApp {
    constructor() {
        this.supabase = null;
        this.currentUser = null;
        this.leads = [];
        this.tasks = [];
        this.activities = [];
        this.apartments = [];
        this.crmUsers = [];
        this.currentLead = null;
        this.currentView = 'dashboard';
        this.isInitialized = false;
    }

    // Initialize the CRM application
    async initialize() {
        try {
            console.log('üöÄ Initializing Enhanced CRM...');
            
            // Initialize Supabase client
            const supabaseResult = await this.initializeSupabase();
            
            // Always proceed with demo mode if needed
            if (!this.currentUser) {
                console.log('‚ö†Ô∏è No user found, setting demo user');
                this.currentUser = { 
                    id: 'demo_user', 
                    email: 'admin@izostone.mk', 
                    full_name: 'Demo Admin',
                    role: 'admin'
                };
            }
            
            // Initialize UI
            this.initializeUI();
            
            // Load initial data
            await this.loadInitialData();
            
            this.isInitialized = true;
            console.log('‚úÖ Enhanced CRM initialized successfully');
            
        } catch (error) {
            console.log('‚ö†Ô∏è CRM initialization issue, using demo mode:', error.message);
            
            // Force demo mode
            this.currentUser = { 
                id: 'demo_user', 
                email: 'admin@izostone.mk', 
                full_name: 'Demo Admin',
                role: 'admin'
            };
            
            this.initializeUI();
            await this.loadInitialData();
            this.isInitialized = true;
            console.log('‚úÖ CRM initialized in demo mode');
        }
    }

    // Initialize Supabase connection
    async initializeSupabase() {
        try {
            if (!window.CONFIG?.SUPABASE_URL || !window.CONFIG?.SUPABASE_ANON_KEY) {
                console.log('‚ö†Ô∏è Demo mode: No Supabase config found');
                this.currentUser = { 
                    id: 'demo_user', 
                    email: 'admin@izostone.mk', 
                    full_name: 'Demo Admin',
                    role: 'admin'
                };
                return true;
            }

            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
            
            this.supabase = createClient(
                window.CONFIG.SUPABASE_URL, 
                window.CONFIG.SUPABASE_ANON_KEY
            );

            // Check authentication
            const { data: { session } } = await this.supabase.auth.getSession();
            
            if (session) {
                this.currentUser = {
                    id: session.user.id,
                    email: session.user.email,
                    full_name: session.user.user_metadata?.full_name || session.user.email,
                    role: 'admin'
                };
                console.log('‚úÖ User authenticated:', this.currentUser.email);
            } else {
                this.showLoginScreen();
                return;
            }
            
        } catch (error) {
            console.log('‚ö†Ô∏è Supabase connection issue, using demo mode:', error.message);
            // Fallback to demo mode
            this.currentUser = { 
                id: 'demo_user', 
                email: 'admin@izostone.mk', 
                full_name: 'Demo Admin',
                role: 'admin'
            };
            return true;
        }
    }

    // Initialize UI elements
    initializeUI() {
        if (this.currentUser) {
            this.showMainScreen();
            // Update user display - using the correct element ID from HTML
            const currentUserNameEl = document.getElementById('currentUserName');
            if (currentUserNameEl) {
                currentUserNameEl.textContent = this.currentUser.full_name;
            }
        }
    }

    // Show login screen
    showLoginScreen() {
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('crmDashboard'); // ‚úÖ Fixed: using correct ID
        
        if (loginScreen) loginScreen.style.display = 'flex';
        if (mainScreen) mainScreen.style.display = 'none';
        
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleLogin();
            });
        }
    }

    // Show main CRM screen
    showMainScreen() {
        const loginScreen = document.getElementById('loginScreen');
        const mainScreen = document.getElementById('crmDashboard'); // ‚úÖ Fixed: using correct ID
        
        if (loginScreen) loginScreen.style.display = 'none';
        if (mainScreen) mainScreen.style.display = 'block';
        this.hideLoading();
    }

    // Handle login
    async handleLogin() {
        // ‚úÖ Fixed: using correct form field IDs
        const username = document.getElementById('loginUsername')?.value;
        const password = document.getElementById('loginPassword')?.value;
        
        try {
            // Demo login check
            if (username === 'admin' && password === 'admin123') {
                this.currentUser = {
                    id: 'demo_user',
                    email: 'admin@izostone.mk',
                    full_name: 'Demo Admin',
                    role: 'admin'
                };
                
                this.showMainScreen();
                await this.loadInitialData();
                return;
            }

            // If Supabase is configured, try real authentication
            if (this.supabase) {
                const { data, error } = await this.supabase.auth.signInWithPassword({
                    email: username,
                    password: password
                });

                if (error) {
                    console.log('‚ùå Login error:', error.message);
                    const loginMessage = document.getElementById('loginMessage');
                    if (loginMessage) {
                        loginMessage.innerHTML = '<div class="error">Invalid credentials</div>';
                    }
                    return;
                }

                this.currentUser = {
                    id: data.user.id,
                    email: data.user.email,
                    full_name: data.user.user_metadata?.full_name || data.user.email,
                    role: 'admin'
                };
            }

            this.showMainScreen();
            await this.loadInitialData();
            
        } catch (error) {
            console.error('‚ùå Login process error:', error);
            const loginMessage = document.getElementById('loginMessage');
            if (loginMessage) {
                loginMessage.innerHTML = '<div class="error">Login failed</div>';
            }
        }
    }

    // Load initial data
    async loadInitialData() {
        try {
            console.log('üìä Loading enhanced CRM data...');
            
            // Demo leads data
            this.leads = [
                {
                    id: 1,
                    name: 'Marina Petrovic',
                    email: 'marina.p@email.com',
                    phone: '+389 70 123 456',
                    apartment_id: '–ê-1204',
                    message: '–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–∏—Ä–∞–Ω–∞ —Å—É–º –∑–∞ –¥–≤–æ—Å–æ–±–µ–Ω —Å—Ç–∞–Ω –Ω–∞ –ø–æ–≤–∏—Å–æ–∫ –∫–∞—Ç.',
                    status: 'new',
                    priority: 'high',
                    budget: 2500.00,
                    source: 'Website',
                    assigned_to: 'Stefan Milosevski',
                    created_at: new Date(Date.now() - 2*60*60*1000).toISOString()
                },
                {
                    id: 2,
                    name: 'Aleksandar Kostovski',
                    email: 'aleksandar.k@email.com',
                    phone: '+389 71 987 654',
                    apartment_id: '–ë-2401',
                    message: '–ë–∏ —Å–∞–∫–∞–ª –¥–∞ –≥–æ –≤–∏–¥–∞–º –ø–µ–Ω—Ç—Ö–∞—É—Å–æ—Ç.',
                    status: 'contacted',
                    priority: 'high',
                    budget: 4200.00,
                    source: 'Facebook',
                    assigned_to: 'Ana Stojanovic',
                    created_at: new Date(Date.now() - 1*24*60*60*1000).toISOString()
                }
            ];

            // Demo tasks data
            this.tasks = [
                {
                    id: 1,
                    title: '–ö–æ–Ω—Ç–∞–∫—Ç —Å–æ –ú–∞—Ä–∏–Ω–∞ –ü.',
                    description: '–ó–∞–∫–∞–∂–∏ –≥–ª–µ–¥–∞—ö–µ –Ω–∞ —Å—Ç–∞–Ω –∏ –¥–∏—Å–∫—É—Ç–∏—Ä–∞—ò —Ñ–∏–Ω–∞–Ω—Å–∏—Å–∫–∏ –æ–ø—Ü–∏–∏',
                    lead_id: 1,
                    assigned_to: 'Stefan Milosevski',
                    due_date: new Date(Date.now() + 2*60*60*1000).toISOString(),
                    priority: 'high',
                    completed: false,
                    task_type: 'follow_up',
                    created_at: new Date().toISOString()
                }
            ];

            // Demo activities data
            this.activities = [
                {
                    id: 1,
                    lead_id: 1,
                    activity_type: 'lead_created',
                    description: '–ù–æ–≤ –ø–æ—Ç–µ–Ω—Ü–∏—ò–∞–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω –æ–¥ –≤–µ–±-—Å–∞—ò—Ç',
                    performed_by: 'System',
                    created_at: new Date(Date.now() - 2*60*60*1000).toISOString()
                }
            ];

            // Update dashboard
            this.updateDashboard();
            
            console.log('‚úÖ Enhanced CRM data loaded');
            
        } catch (error) {
            console.error('‚ùå Error loading demo data:', error);
        }
    }

    // Update dashboard statistics
    updateDashboard() {
        const newLeads = this.leads.filter(lead => lead.status === 'new').length;
        const activeLeads = this.leads.filter(lead => 
            !['closed_won', 'closed_lost'].includes(lead.status)
        ).length;
        const closedDeals = this.leads.filter(lead => lead.status === 'closed_won').length;
        const conversionRate = this.leads.length > 0 ? 
            Math.round((closedDeals / this.leads.length) * 100) : 0;

        // ‚úÖ Fixed: Using safe element access
        const newLeadsCountEl = document.getElementById('newLeadsCount');
        const activeLeadsCountEl = document.getElementById('activeLeadsCount');
        const closedDealsCountEl = document.getElementById('closedDealsCount');
        const conversionRateEl = document.getElementById('conversionRate');
        const newLeadsBadgeEl = document.getElementById('newLeadsBadge');

        if (newLeadsCountEl) newLeadsCountEl.textContent = newLeads;
        if (activeLeadsCountEl) activeLeadsCountEl.textContent = activeLeads;
        if (closedDealsCountEl) closedDealsCountEl.textContent = closedDeals;
        if (conversionRateEl) conversionRateEl.textContent = conversionRate + '%';
        if (newLeadsBadgeEl) newLeadsBadgeEl.textContent = newLeads;
    }

    // Show view
    showView(viewName) {
        this.currentView = viewName;
        
        // Update navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[onclick="showView('${viewName}')"]`)?.classList.add('active');
        
        // Update content
        document.querySelectorAll('.view-content').forEach(view => {
            view.classList.remove('active');
        });
        
        const viewElement = document.getElementById(viewName + 'View');
        if (viewElement) {
            viewElement.classList.add('active');
        }
        
        if (viewName === 'leads') {
            this.updateLeadsTable();
        }
    }

    // Update leads table
    updateLeadsTable() {
        const tbody = document.getElementById('leadsTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = this.leads.map(lead => `
            <tr class="lead-row" onclick="showLeadDetail('${lead.id}')">
                <td>
                    <div class="lead-name">${lead.name}</div>
                    <div class="lead-email">${lead.email}</div>
                </td>
                <td>
                    ${lead.apartment_id ? '<span class="apartment-tag">' + lead.apartment_id + '</span>' : '-'}
                </td>
                <td>
                    <span class="status-badge ${lead.status}">${lead.status.replace('_', ' ')}</span>
                </td>
                <td>
                    <span class="priority-badge ${lead.priority}">${lead.priority}</span>
                </td>
                <td>
                    ${lead.assigned_to || 'Unassigned'}
                </td>
                <td>
                    ${this.formatDate(lead.created_at)}
                </td>
                <td>
                    <button class="action-btn" onclick="event.stopPropagation(); showLeadDetail('${lead.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Show lead detail modal
    async showLeadDetail(leadId) {
        const lead = this.leads.find(l => l.id == leadId);
        if (!lead) return;
        
        this.currentLead = lead;
        
        // Update modal content
        const leadDetailTitle = document.getElementById('leadDetailTitle');
        const leadContactInfo = document.getElementById('leadContactInfo');
        const leadDetailModal = document.getElementById('leadDetailModal');
        
        if (leadDetailTitle) {
            leadDetailTitle.textContent = 'Lead: ' + lead.name;
        }
        
        if (leadContactInfo) {
            leadContactInfo.innerHTML = `
                <div class="contact-info-grid">
                    <div class="info-item">
                        <label>Name:</label>
                        <span>${lead.name}</span>
                    </div>
                    <div class="info-item">
                        <label>Email:</label>
                        <span>${lead.email}</span>
                    </div>
                    <div class="info-item">
                        <label>Phone:</label>
                        <span>${lead.phone || 'Not provided'}</span>
                    </div>
                    <div class="info-item">
                        <label>Apartment:</label>
                        <span>${lead.apartment_id || 'Not specified'}</span>
                    </div>
                    <div class="info-item full-width">
                        <label>Message:</label>
                        <div class="message-content">${lead.message}</div>
                    </div>
                </div>
            `;
        }
        
        // Show modal
        if (leadDetailModal) {
            leadDetailModal.classList.add('show');
        }
    }

    // Format date
    formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('mk-MK', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    // Enhanced CRM features
    loadTasks() {
        const pendingTasks = this.tasks.filter(task => !task.completed);
        console.log('üìã Tasks loaded:', pendingTasks.length, 'pending');
    }

    async completeTask(taskId) {
        const task = this.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        task.completed = true;
        task.completed_at = new Date().toISOString();
        
        console.log('‚úÖ Task completed:', task.title);
    }

    logActivity(leadId, activityType, description, performedBy) {
        const newActivity = {
            id: this.activities.length + 1,
            lead_id: leadId,
            activity_type: activityType,
            description: description,
            performed_by: performedBy || this.currentUser.full_name,
            created_at: new Date().toISOString()
        };
        
        this.activities.push(newActivity);
        console.log('üìã Activity logged:', activityType);
    }

    // Hide loading overlay
    hideLoading() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
    }

    // Logout
    async logout() {
        try {
            if (this.supabase) {
                await this.supabase.auth.signOut();
            }
            window.location.reload();
        } catch (error) {
            console.error('‚ùå Logout error:', error);
            window.location.reload();
        }
    }
}

// Global CRM app instance
let crmApp;

// Global functions for HTML onclick handlers
function showView(viewName) {
    crmApp?.showView(viewName);
}

function showLeadDetail(leadId) {
    crmApp?.showLeadDetail(leadId);
}

function closeLeadDetailModal() {
    const modal = document.getElementById('leadDetailModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdown');
    dropdown?.classList.toggle('show');
}

function logout() {
    crmApp?.logout();
}

function completeTask(taskId) {
    crmApp?.completeTask(taskId);
}

// Initialize CRM when DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
    crmApp = new CRMApp();
    await crmApp.initialize();
});

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-menu')) {
        document.getElementById('userDropdown')?.classList.remove('show');
    }
});

console.log('‚úÖ Enhanced CRM Module Loaded');